generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Gender {
  MALE
  FEMALE
}

enum ServiceType {
  TUESDAY_FELLOWSHIP
  THURSDAY_PHANEROO
}

enum CheckInMethod {
  QR
  FELLOWSHIP_NUMBER
  MANUAL
}

enum TransportStatus {
  PENDING
  CONFIRMED
  CANCELLED
}

enum Role {
  MEMBER
  FELLOWSHIP_MANAGER
}

enum TagType {
  SYSTEM
  CUSTOM
}

enum RegistrationMode {
  NEW_MEMBER        // Fresh registration, auto-assign PENDING_FIRST_ATTENDANCE tag
  LEGACY_IMPORT     // Bulk import of existing members, skip first-timer tag
  TRANSFER          // Transfer from another fellowship
  READMISSION       // Returning after absence
}

enum DecisionType {
  SALVATION
  REDEDICATION
  BAPTISM_INTEREST
  PRAYER_REQUEST
}

enum FollowUpStatus {
  PENDING
  FIRST_CONTACT_MADE
  ONGOING_DISCIPLESHIP
  BAPTIZED
  INTEGRATED
  LOST_CONTACT
}

model Region {
  id        String   @id @default(uuid())
  name      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Regional Head (one-to-one: one region has one head, one member can only head one region)
  regionalHeadId String? @unique
  regionalHead   Member? @relation("RegionalHead", fields: [regionalHeadId], references: [id])

  members    Member[]
  residences Residence[]
  families   FamilyGroup[]

  @@index([name])
  @@index([regionalHeadId])
}

model Member {
  id                     String    @id @default(uuid())
  fullName               String
  email                  String    @unique
  phoneNumber            String
  password               String
  role                   Role      @default(MEMBER)
  fellowshipNumber       String    @unique
  gender                 Gender
  regionId               String
  region                 Region    @relation(fields: [regionId], references: [id], onDelete: Restrict)
  residenceId            String?
  residence              Residence? @relation(fields: [residenceId], references: [id])
  hostelName             String?
  courseId               String?
  courseRelation         Course?   @relation(fields: [courseId], references: [id])
  course                 String?
  registrationDate       DateTime  @default(now())
  registrationMode       RegistrationMode @default(NEW_MEMBER)
  initialYearOfStudy     Int?
  initialSemester        Int?
  qrCode                 String    @unique @default(uuid())
  createdAt              DateTime  @default(now())
  updatedAt              DateTime  @updatedAt
  
  // Security fields
  failedLoginAttempts    Int       @default(0)
  lockedUntil            DateTime?
  lastLoginAttempt       DateTime?
  lastSuccessfulLogin    DateTime?

  attendances         Attendance[]
  transportBookings   TransportBooking[]
  volunteers          EventVolunteer[]
  memberTags          MemberTag[]
  tagsAssigned        MemberTag[]        @relation("TagAssigner")
  tagsRemoved         MemberTag[]        @relation("TagRemover")
  salvations          Salvation[] // Salvations for this member
  counseledSalvations Salvation[]        @relation("SalvationCounselor") // Salvations counseled by this member

  // Leadership roles
  headsRegion              Region?               @relation("RegionalHead")
  headsFamilies            FamilyGroup[]         @relation("FamilyHead")
  assistsInFamilies        FamilyGroup[]         @relation("FamilyAssistant")
  familiesCreated          FamilyGroup[]         @relation("FamilyCreator")
  leadsMinistryTeams       MinistryTeam[]        @relation("TeamLeader")
  assistsMinistryTeams     MinistryTeam[]        @relation("TeamAssistant")
  createdTeams             MinistryTeam[]        @relation("TeamCreator")

  // Memberships
  familyMemberships        FamilyMember[]
  ministryMemberships      MinistryTeamMember[]

  // Assignments
  familyMembersAssigned    FamilyMember[]        @relation("FamilyMemberAssigner")
  ministryMembersAssigned  MinistryTeamMember[]  @relation("MinistryTeamAssigner")

  // Created records
  familyMeetingsCreated    FamilyMeeting[]
  schedulesCreated         MinistrySchedule[]
  
  // Security relations
  loginAttempts            LoginAttempt[]
  otps                     OTP[]

  @@index([phoneNumber])
  @@index([email])
  @@index([fellowshipNumber])
  @@index([regionId])
}

model Event {
  id                String      @id @default(uuid())
  name              String
  date              DateTime
  startTime         String // Format: "HH:MM"
  endTime           String // Format: "HH:MM"
  type              ServiceType
  venue             String?
  isRecurring       Boolean     @default(false)
  recurrenceRule    String? // DAILY, WEEKLY, MONTHLY
  isActive          Boolean     @default(false)
  allowGuestCheckin Boolean     @default(false)
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt

  attendances       Attendance[]
  guestAttendances  GuestAttendance[]
  transportBookings TransportBooking[]
  volunteers        EventVolunteer[]
  salvations        Salvation[]
  ministrySchedules MinistrySchedule[]

  @@index([date])
  @@index([isActive])
}

model Attendance {
  id          String        @id @default(uuid())
  memberId    String
  eventId     String
  method      CheckInMethod
  checkedInAt DateTime      @default(now())

  member Member @relation(fields: [memberId], references: [id])
  event  Event  @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@unique([memberId, eventId])
}

model TransportBooking {
  id          String          @id @default(uuid())
  memberId    String
  eventId     String
  pickupPoint String
  status      TransportStatus @default(PENDING)
  bookedAt    DateTime        @default(now())

  member Member @relation(fields: [memberId], references: [id])
  event  Event  @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@unique([memberId, eventId])
}

model GuestAttendance {
  id          String   @id @default(uuid())
  eventId     String
  guestName   String
  guestPhone  String?
  purpose     String?
  checkedInAt DateTime @default(now())

  event Event @relation(fields: [eventId], references: [id], onDelete: Cascade)
}

model EventVolunteer {
  id         String   @id @default(uuid())
  eventId    String
  memberId   String
  assignedAt DateTime @default(now())

  event  Event  @relation(fields: [eventId], references: [id], onDelete: Cascade)
  member Member @relation(fields: [memberId], references: [id])

  @@unique([eventId, memberId])
}

model College {
  id        String   @id @default(uuid())
  name      String   @unique
  code      String?  @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  courses   Course[]
}

model Residence {
  id        String   @id @default(uuid())
  name      String   @unique
  type      String   @default("HALL")
  regionId  String?
  region    Region?  @relation(fields: [regionId], references: [id])
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  members   Member[]

  @@index([name])
  @@index([regionId])
}

model Course {
  id            String   @id @default(uuid())
  name          String   @unique
  code          String   @unique
  durationYears Int      @default(3)
  collegeId     String?
  college       College? @relation(fields: [collegeId], references: [id])
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  members       Member[]
}

model Tag {
  id                 String      @id @default(uuid())
  name               String      @unique
  description        String?
  type               TagType     @default(CUSTOM)
  color              String      @default("#6366f1")
  isSystem           Boolean     @default(false)
  showOnRegistration Boolean     @default(false)
  createdAt          DateTime    @default(now())
  createdBy          String?
  memberTags         MemberTag[]

  @@index([name])
  @@index([isSystem])
  @@index([showOnRegistration])
}

model MemberTag {
  id         String    @id @default(uuid())
  memberId   String
  tagId      String
  assignedBy String
  assignedAt DateTime  @default(now())
  removedBy  String?
  removedAt  DateTime?
  expiresAt  DateTime?
  notes      String?
  isActive   Boolean   @default(true)

  member   Member  @relation(fields: [memberId], references: [id], onDelete: Cascade)
  tag      Tag     @relation(fields: [tagId], references: [id], onDelete: Cascade)
  assigner Member  @relation("TagAssigner", fields: [assignedBy], references: [id])
  remover  Member? @relation("TagRemover", fields: [removedBy], references: [id])

  @@unique([memberId, tagId, isActive])
  @@index([memberId])
  @@index([tagId])
  @@index([isActive])
  @@index([expiresAt])
}

model Salvation {
  id String @id @default(uuid())

  // Event relationship
  eventId String
  event   Event  @relation(fields: [eventId], references: [id], onDelete: Cascade)

  // Person information (Member or Guest)
  memberId String?
  member   Member? @relation(fields: [memberId], references: [id], onDelete: SetNull)

  // Guest information (if not a member)
  guestName  String?
  guestPhone String?
  guestEmail String?

  // Counselor/Minister
  counselorId String?
  counselor   Member? @relation("SalvationCounselor", fields: [counselorId], references: [id], onDelete: SetNull)

  // Decision details
  decisionDate DateTime     @default(now())
  decisionType DecisionType @default(SALVATION)

  // Follow-up tracking
  followUpStatus       FollowUpStatus @default(PENDING)
  firstContactDate     DateTime?
  baptismInterest      Boolean        @default(false)
  baptismDate          DateTime?
  assignedToSmallGroup Boolean        @default(false)
  smallGroupName       String?

  // Notes and testimony
  notes     String? @db.Text
  testimony String? @db.Text

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String?

  @@index([eventId])
  @@index([memberId])
  @@index([decisionDate])
  @@index([followUpStatus])
}

// ============================================
// LEADERSHIP & TEAMS SYSTEM
// ============================================

model FamilyGroup {
  id                 String          @id @default(uuid())
  name               String
  regionId           String
  region             Region          @relation(fields: [regionId], references: [id])
  
  // Family Head
  familyHeadId       String?
  familyHead         Member?         @relation("FamilyHead", fields: [familyHeadId], references: [id])
  
  // Assistant (optional)
  assistantId        String?
  assistant          Member?         @relation("FamilyAssistant", fields: [assistantId], references: [id])
  
  // Flexible Meeting Schedule
  meetingDayLocked   Boolean         @default(false)
  meetingDay         String?         // "Sunday", "Monday", etc.
  meetingTimeLocked  Boolean         @default(false)
  meetingTime        String?         // "17:00" in 24hr format
  meetingVenueLocked Boolean         @default(false)
  meetingVenue       String?         // "Olympia", "MSH Common Room"
  
  // Auto-generated tag name for family members
  memberTagName      String          // e.g., "GRACE_FAMILY_MEMBER"
  
  isActive           Boolean         @default(true)
  createdAt          DateTime        @default(now())
  createdBy          String
  creator            Member          @relation("FamilyCreator", fields: [createdBy], references: [id])
  updatedAt          DateTime        @updatedAt
  
  members            FamilyMember[]
  meetings           FamilyMeeting[]
  
  @@index([regionId])
  @@index([familyHeadId])
  @@index([createdBy])
}

model FamilyMember {
  id         String      @id @default(uuid())
  familyId   String
  family     FamilyGroup @relation(fields: [familyId], references: [id], onDelete: Cascade)
  memberId   String
  member     Member      @relation(fields: [memberId], references: [id], onDelete: Cascade)
  
  joinedAt   DateTime    @default(now())
  leftAt     DateTime?
  isActive   Boolean     @default(true)
  
  assignedBy String
  assigner   Member      @relation("FamilyMemberAssigner", fields: [assignedBy], references: [id])
  
  notes      String?
  
  @@unique([familyId, memberId, isActive])
  @@index([familyId])
  @@index([memberId])
}

model MinistryTeam {
  id             String                @id @default(uuid())
  name           String                @unique
  description    String?
  
  // Auto-generated tag names
  leaderTagName  String
  memberTagName  String
  
  // Team Leader
  leaderId       String?
  leader         Member?               @relation("TeamLeader", fields: [leaderId], references: [id])
  
  // Assistant Leader (optional)
  assistantId    String?
  assistant      Member?               @relation("TeamAssistant", fields: [assistantId], references: [id])
  
  isActive       Boolean               @default(true)
  createdAt      DateTime              @default(now())
  createdBy      String
  creator        Member                @relation("TeamCreator", fields: [createdBy], references: [id])
  updatedAt      DateTime              @updatedAt
  
  members        MinistryTeamMember[]
  schedules      MinistrySchedule[]
  
  @@index([name])
  @@index([leaderId])
  @@index([createdBy])
}

model MinistryTeamMember {
  id         String       @id @default(uuid())
  teamId     String
  team       MinistryTeam @relation(fields: [teamId], references: [id], onDelete: Cascade)
  memberId   String
  member     Member       @relation(fields: [memberId], references: [id], onDelete: Cascade)
  
  // Specific role (optional, free text)
  role       String?      // "Lead Vocalist", "Keyboardist", "Door 1", etc.
  
  joinedAt   DateTime     @default(now())
  leftAt     DateTime?
  isActive   Boolean      @default(true)
  
  assignedBy String
  assigner   Member       @relation("MinistryTeamAssigner", fields: [assignedBy], references: [id])
  
  notes      String?
  
  @@unique([teamId, memberId, isActive])
  @@index([teamId])
  @@index([memberId])
}

model FamilyMeeting {
  id        String      @id @default(uuid())
  familyId  String
  family    FamilyGroup @relation(fields: [familyId], references: [id], onDelete: Cascade)
  
  date      DateTime
  venue     String?
  topic     String?
  notes     String?     @db.Text
  attendees String[]    // Member IDs who attended
  
  createdBy String
  creator   Member      @relation(fields: [createdBy], references: [id])
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
  
  @@index([familyId])
  @@index([date])
}

model MinistrySchedule {
  id        String       @id @default(uuid())
  teamId    String
  team      MinistryTeam @relation(fields: [teamId], references: [id], onDelete: Cascade)
  eventId   String?
  event     Event?       @relation(fields: [eventId], references: [id], onDelete: SetNull)
  
  date      DateTime
  memberIds String[]     // Who's scheduled to serve
  
  notes     String?      @db.Text
  
  createdBy String
  creator   Member       @relation(fields: [createdBy], references: [id])
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt
  
  @@index([teamId])
  @@index([eventId])
  @@index([date])
}

// ============================================
// ACADEMIC CALENDAR SYSTEM
// ============================================

model AcademicPeriod {
  id              String   @id @default(uuid())
  academicYear    String   // "2025/2026"
  periodNumber    Int      // 1 or 2
  periodName      String   // "First Period" / "Second Period"
  startDate       DateTime
  endDate         DateTime
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@unique([academicYear, periodNumber])
  @@index([startDate, endDate])
}

// ===================================
// SECURITY MODELS
// ===================================

model LoginAttempt {
  id          String   @id @default(cuid())
  memberId    String?
  email       String
  ipAddress   String
  userAgent   String?
  success     Boolean
  reason      String?  // "invalid_password", "account_locked", "invalid_email", etc.
  timestamp   DateTime @default(now())
  
  member      Member?  @relation(fields: [memberId], references: [id], onDelete: Cascade)
  
  @@index([email])
  @@index([timestamp])
  @@index([ipAddress])
  @@index([memberId])
}

model OTP {
  id          String   @id @default(cuid())
  memberId    String
  code        String
  expiresAt   DateTime
  verified    Boolean  @default(false)
  attempts    Int      @default(0)
  createdAt   DateTime @default(now())
  
  member      Member   @relation(fields: [memberId], references: [id], onDelete: Cascade)
  
  @@index([memberId])
  @@index([expiresAt])
}
