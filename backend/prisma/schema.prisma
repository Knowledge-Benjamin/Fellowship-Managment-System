generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Gender {
  MALE
  FEMALE
}

enum ServiceType {
  TUESDAY_FELLOWSHIP
  THURSDAY_PHANEROO
}

enum CheckInMethod {
  QR
  FELLOWSHIP_NUMBER
  MANUAL
}

enum TransportStatus {
  PENDING
  CONFIRMED
  CANCELLED
}

enum Role {
  MEMBER
  FELLOWSHIP_MANAGER
}

enum TagType {
  SYSTEM
  CUSTOM
}

model Region {
  id        String   @id @default(uuid())
  name      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  members Member[]

  @@index([name])
}

model Member {
  id               String   @id @default(uuid())
  fullName         String
  email            String   @unique
  phoneNumber      String
  password         String
  role             Role     @default(MEMBER)
  fellowshipNumber String   @unique
  gender           Gender
  regionId         String
  region           Region   @relation(fields: [regionId], references: [id], onDelete: Restrict)
  course           String?
  yearOfStudy      Int?
  qrCode           String   @unique @default(uuid())
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  attendances       Attendance[]
  transportBookings TransportBooking[]
  volunteers        EventVolunteer[]
  memberTags        MemberTag[]
  tagsAssigned      MemberTag[]       @relation("TagAssigner")
  tagsRemoved       MemberTag[]       @relation("TagRemover")

  @@index([phoneNumber])
  @@index([email])
  @@index([fellowshipNumber])
  @@index([regionId])
}

model Event {
  id                String      @id @default(uuid())
  name              String
  date              DateTime
  startTime         String // Format: "HH:MM"
  endTime           String // Format: "HH:MM"
  type              ServiceType
  venue             String?
  isRecurring       Boolean     @default(false)
  recurrenceRule    String? // DAILY, WEEKLY, MONTHLY
  isActive          Boolean     @default(false)
  allowGuestCheckin Boolean     @default(false)
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt

  attendances       Attendance[]
  guestAttendances  GuestAttendance[]
  transportBookings TransportBooking[]
  volunteers        EventVolunteer[]

  @@index([date])
  @@index([isActive])
}

model Attendance {
  id          String        @id @default(uuid())
  memberId    String
  eventId     String
  method      CheckInMethod
  checkedInAt DateTime      @default(now())

  member Member @relation(fields: [memberId], references: [id])
  event  Event  @relation(fields: [eventId], references: [id])

  @@unique([memberId, eventId])
}

model TransportBooking {
  id          String          @id @default(uuid())
  memberId    String
  eventId     String
  pickupPoint String
  status      TransportStatus @default(PENDING)
  bookedAt    DateTime        @default(now())

  member Member @relation(fields: [memberId], references: [id])
  event  Event  @relation(fields: [eventId], references: [id])

  @@unique([memberId, eventId])
}

model GuestAttendance {
  id          String   @id @default(uuid())
  eventId     String
  guestName   String
  guestPhone  String?
  purpose     String?
  checkedInAt DateTime @default(now())

  event Event @relation(fields: [eventId], references: [id])
}

model EventVolunteer {
  id        String   @id @default(uuid())
  eventId   String
  memberId  String
  assignedAt DateTime @default(now())

  event  Event  @relation(fields: [eventId], references: [id])
  member Member @relation(fields: [memberId], references: [id])

  @@unique([eventId, memberId])
}

model Tag {
  id          String    @id @default(uuid())
  name        String    @unique
  description String?
  type        TagType   @default(CUSTOM)
  color       String    @default("#6366f1")
  isSystem    Boolean   @default(false)
  createdAt   DateTime  @default(now())
  createdBy   String?
  memberTags  MemberTag[]

  @@index([name])
  @@index([isSystem])
}

model MemberTag {
  id         String    @id @default(uuid())
  memberId   String
  tagId      String
  assignedBy String
  assignedAt DateTime  @default(now())
  removedBy  String?
  removedAt  DateTime?
  expiresAt  DateTime?
  notes      String?
  isActive   Boolean   @default(true)

  member   Member @relation(fields: [memberId], references: [id], onDelete: Cascade)
  tag      Tag    @relation(fields: [tagId], references: [id], onDelete: Cascade)
  assigner Member @relation("TagAssigner", fields: [assignedBy], references: [id])
  remover  Member? @relation("TagRemover", fields: [removedBy], references: [id])

  @@unique([memberId, tagId, isActive])
  @@index([memberId])
  @@index([tagId])
  @@index([isActive])
  @@index([expiresAt])
}
