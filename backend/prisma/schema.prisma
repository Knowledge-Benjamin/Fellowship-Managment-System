generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Gender {
  MALE
  FEMALE
}

enum ServiceType {
  TUESDAY_FELLOWSHIP
  THURSDAY_PHANEROO
}

enum CheckInMethod {
  QR
  FELLOWSHIP_NUMBER
  MANUAL
}

enum TransportStatus {
  PENDING
  CONFIRMED
  CANCELLED
}

enum Role {
  MEMBER
  FELLOWSHIP_MANAGER
}

enum TagType {
  SYSTEM
  CUSTOM
}

enum DecisionType {
  SALVATION
  REDEDICATION
  BAPTISM_INTEREST
  PRAYER_REQUEST
}

enum FollowUpStatus {
  PENDING
  FIRST_CONTACT_MADE
  ONGOING_DISCIPLESHIP
  BAPTIZED
  INTEGRATED
  LOST_CONTACT
}

model Region {
  id        String   @id @default(uuid())
  name      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  members Member[]

  @@index([name])
}

model Member {
  id               String   @id @default(uuid())
  fullName         String
  email            String   @unique
  phoneNumber      String
  password         String
  role             Role     @default(MEMBER)
  fellowshipNumber String   @unique
  gender           Gender
  regionId         String
  region           Region   @relation(fields: [regionId], references: [id], onDelete: Restrict)
  courseId         String?
  courseRelation   Course?  @relation(fields: [courseId], references: [id])
  course           String?
  yearOfStudy      Int?
  qrCode           String   @unique @default(uuid())
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  attendances         Attendance[]
  transportBookings   TransportBooking[]
  volunteers          EventVolunteer[]
  memberTags          MemberTag[]
  tagsAssigned        MemberTag[]        @relation("TagAssigner")
  tagsRemoved         MemberTag[]        @relation("TagRemover")
  salvations          Salvation[] // Salvations for this member
  counseledSalvations Salvation[]        @relation("SalvationCounselor") // Salvations counseled by this member

  @@index([phoneNumber])
  @@index([email])
  @@index([fellowshipNumber])
  @@index([regionId])
}

model Event {
  id                String      @id @default(uuid())
  name              String
  date              DateTime
  startTime         String // Format: "HH:MM"
  endTime           String // Format: "HH:MM"
  type              ServiceType
  venue             String?
  isRecurring       Boolean     @default(false)
  recurrenceRule    String? // DAILY, WEEKLY, MONTHLY
  isActive          Boolean     @default(false)
  allowGuestCheckin Boolean     @default(false)
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt

  attendances       Attendance[]
  guestAttendances  GuestAttendance[]
  transportBookings TransportBooking[]
  volunteers        EventVolunteer[]
  salvations        Salvation[]

  @@index([date])
  @@index([isActive])
}

model Attendance {
  id          String        @id @default(uuid())
  memberId    String
  eventId     String
  method      CheckInMethod
  checkedInAt DateTime      @default(now())

  member Member @relation(fields: [memberId], references: [id])
  event  Event  @relation(fields: [eventId], references: [id])

  @@unique([memberId, eventId])
}

model TransportBooking {
  id          String          @id @default(uuid())
  memberId    String
  eventId     String
  pickupPoint String
  status      TransportStatus @default(PENDING)
  bookedAt    DateTime        @default(now())

  member Member @relation(fields: [memberId], references: [id])
  event  Event  @relation(fields: [eventId], references: [id])

  @@unique([memberId, eventId])
}

model GuestAttendance {
  id          String   @id @default(uuid())
  eventId     String
  guestName   String
  guestPhone  String?
  purpose     String?
  checkedInAt DateTime @default(now())

  event Event @relation(fields: [eventId], references: [id])
}

model EventVolunteer {
  id         String   @id @default(uuid())
  eventId    String
  memberId   String
  assignedAt DateTime @default(now())

  event  Event  @relation(fields: [eventId], references: [id])
  member Member @relation(fields: [memberId], references: [id])

  @@unique([eventId, memberId])
}

model College {
  id        String   @id @default(uuid())
  name      String   @unique
  code      String?  @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  courses   Course[]
}

model Course {
  id        String   @id @default(uuid())
  name      String   @unique
  code      String   @unique
  collegeId String?
  college   College? @relation(fields: [collegeId], references: [id])
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  members   Member[]
}

model Tag {
  id                 String      @id @default(uuid())
  name               String      @unique
  description        String?
  type               TagType     @default(CUSTOM)
  color              String      @default("#6366f1")
  isSystem           Boolean     @default(false)
  showOnRegistration Boolean     @default(false)
  createdAt          DateTime    @default(now())
  createdBy          String?
  memberTags         MemberTag[]

  @@index([name])
  @@index([isSystem])
  @@index([showOnRegistration])
}

model MemberTag {
  id         String    @id @default(uuid())
  memberId   String
  tagId      String
  assignedBy String
  assignedAt DateTime  @default(now())
  removedBy  String?
  removedAt  DateTime?
  expiresAt  DateTime?
  notes      String?
  isActive   Boolean   @default(true)

  member   Member  @relation(fields: [memberId], references: [id], onDelete: Cascade)
  tag      Tag     @relation(fields: [tagId], references: [id], onDelete: Cascade)
  assigner Member  @relation("TagAssigner", fields: [assignedBy], references: [id])
  remover  Member? @relation("TagRemover", fields: [removedBy], references: [id])

  @@unique([memberId, tagId, isActive])
  @@index([memberId])
  @@index([tagId])
  @@index([isActive])
  @@index([expiresAt])
}

model Salvation {
  id String @id @default(uuid())

  // Event relationship
  eventId String
  event   Event  @relation(fields: [eventId], references: [id], onDelete: Cascade)

  // Person information (Member or Guest)
  memberId String?
  member   Member? @relation(fields: [memberId], references: [id], onDelete: SetNull)

  // Guest information (if not a member)
  guestName  String?
  guestPhone String?
  guestEmail String?

  // Counselor/Minister
  counselorId String?
  counselor   Member? @relation("SalvationCounselor", fields: [counselorId], references: [id], onDelete: SetNull)

  // Decision details
  decisionDate DateTime     @default(now())
  decisionType DecisionType @default(SALVATION)

  // Follow-up tracking
  followUpStatus       FollowUpStatus @default(PENDING)
  firstContactDate     DateTime?
  baptismInterest      Boolean        @default(false)
  baptismDate          DateTime?
  assignedToSmallGroup Boolean        @default(false)
  smallGroupName       String?

  // Notes and testimony
  notes     String? @db.Text
  testimony String? @db.Text

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String?

  @@index([eventId])
  @@index([memberId])
  @@index([decisionDate])
  @@index([followUpStatus])
}
